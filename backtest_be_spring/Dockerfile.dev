# Development Dockerfile with Hot Reload support
FROM gradle:8.12-jdk17

WORKDIR /app

# Gradle 캐시 디렉토리 설정
ENV GRADLE_USER_HOME=/home/gradle/.gradle
RUN mkdir -p ${GRADLE_USER_HOME} && chown -R gradle:gradle ${GRADLE_USER_HOME}

# 작업 디렉토리 권한 설정 (root 권한으로)
RUN chown -R gradle:gradle /app

# 의존성을 먼저 다운로드하여 캐싱 (빌드 시간 단축)
COPY --chown=gradle:gradle build.gradle settings.gradle ./
COPY --chown=gradle:gradle gradle ./gradle
COPY --chown=gradle:gradle gradlew ./
RUN chmod +x ./gradlew

# gradle 사용자로 전환
USER gradle

# 빌드 디렉토리 생성
RUN mkdir -p /app/.gradle /app/build /app/bin

# 의존성 다운로드
RUN ./gradlew dependencies --no-daemon || true

# 소스 코드는 볼륨 마운트로 처리될 예정이므로 여기서는 복사하지 않음
# 하지만 초기 빌드를 위해 더미 src 디렉토리 생성
RUN mkdir -p src/main/java src/main/resources src/test/java src/test/resources

# 포트 노출
EXPOSE 8080

# DevTools를 사용한 Hot Reload 실행
# --continuous 옵션으로 파일 변경 감지
CMD ["./gradlew", "bootRun", "--continuous", "-x", "test", "--no-daemon"]
